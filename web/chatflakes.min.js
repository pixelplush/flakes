const e="https://api.pixelplush.dev/v1";let a="PixelPlush ChatFlakes",t={},n={},o="",s=1,r=3,l=0,i={},c={};function h(){!function(e,a){d++;let t="particle_"+d,n=Unicorn.AddObject(t,{type:"rectangle",scale:{x:3,y:3},animations:{anim:{framerate:c[e],frames:i[e].slice(),loop:!1}},isStatic:!0,x:a,y:0,z:100});"rainbow"!==e&&"sunrays"!==e&&(n.animations.anim.alpha=.25+.5*Math.random()),n.animations.anim.anchor.set(0),setTimeout((()=>{Unicorn.RemoveObject(t)}),.25*c[e]*i[e].length*1e3)}(`raindrop_${b(3)+1}`,b(1920))}function f(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,n.snow,n.leaves&&(Unicorn.Load("leaf_gold",`${o}/assets/game-parachute/autumn_theme/leaf_gold.png`),Unicorn.Load("leaf1",`${o}/assets/game-parachute/autumn_theme/leaf1.png`),Unicorn.Load("leaf2",`${o}/assets/game-parachute/autumn_theme/leaf2.png`),Unicorn.Load("leaf3",`${o}/assets/game-parachute/autumn_theme/leaf3.png`),Unicorn.Load("leaf4",`${o}/assets/game-parachute/autumn_theme/leaf4.png`),Unicorn.Load("leaf5",`${o}/assets/game-parachute/autumn_theme/leaf5.png`),Unicorn.Load("leaf6",`${o}/assets/game-parachute/autumn_theme/leaf6.png`),Unicorn.Load("oak_gold",`${o}/assets/game-parachute/autumn_theme/oak_gold.png`),Unicorn.Load("oak1",`${o}/assets/game-parachute/autumn_theme/oak1.png`),Unicorn.Load("oak2",`${o}/assets/game-parachute/autumn_theme/oak2.png`),Unicorn.Load("oak3",`${o}/assets/game-parachute/autumn_theme/oak3.png`),Unicorn.Load("oak4",`${o}/assets/game-parachute/autumn_theme/oak4.png`),Unicorn.Load("oak5",`${o}/assets/game-parachute/autumn_theme/oak5.png`),Unicorn.Load("oak6",`${o}/assets/game-parachute/autumn_theme/oak6.png`),l>0&&setInterval((()=>{for(let e=0;e<r;e++)y(u[b(u.length)])}),l)),n.snow&&(Unicorn.Load("snowflake1",`${o}/assets/game-parachute/christmas_theme/snowflake_1.png`),Unicorn.Load("snowflake2",`${o}/assets/game-parachute/christmas_theme/snowflake_2.png`),Unicorn.Load("snowflake3",`${o}/assets/game-parachute/christmas_theme/snowflake_3.png`),Unicorn.Load("snowflake4",`${o}/assets/game-parachute/christmas_theme/snowflake_4.png`),Unicorn.Load("snowflake5",`${o}/assets/game-parachute/christmas_theme/snowflake_5.png`),Unicorn.Load("snowflake6",`${o}/assets/game-parachute/christmas_theme/snowflake_6.png`),Unicorn.Load("snowflake7",`${o}/assets/game-parachute/christmas_theme/snowflake_7.png`),l>0&&setInterval((()=>{for(let e=0;e<r;e++)v(m[b(m.length)])}),l)),n.blossoms){for(let e=0;e<12;e++)Unicorn.Load(`blossom${e+1}`,`${o}/assets/game-parachute/spring_theme/petal${e+1}.png`);l>0&&setInterval((()=>{for(let e=0;e<r;e++)U(p[b(p.length)])}),l)}if(n.rain){for(let e=1;e<=3;e++){i[`raindrop_${e}`]=[],c[`raindrop_${e}`]=16/60;for(let a=0;a<10;a++)Unicorn.Load(`raindrop_${e}_${a}`,`${o}/assets/stream-weather/raindrop/raindrop${e}/raindrop${e}_${a+1}.png`),i[`raindrop_${e}`].push(`raindrop_${e}_${a}`)}l>0&&setInterval((()=>{for(let e=0;e<r;e++)h()}),l)}n.hearts&&(g.forEach((e=>{Unicorn.Load(e,`${o}/assets/game-parachute/valentines/${e}.png`)})),l>0&&setInterval((()=>{for(let e=0;e<r;e++){const e=b(g.length);L(g[e])}}),l))}const u=["leaf1","leaf2","leaf3","leaf4","leaf5","leaf6","oak1","oak2","oak3","oak4","oak5","oak6"],m=["snowflake1","snowflake2","snowflake3","snowflake4","snowflake5","snowflake6","snowflake7"],p=Array.from({length:12},((e,a)=>`blossom${a+1}`)),g=["heart_gold1","heart_gold2","heart_pink1","heart_pink2","heart_red1","heart_red2"];let d=0,_=[],k=[],w=[],$=[];function y(e){let a=n.leaves2?b(1080):b(2160)-1080,t=b(10),o="leaf_"+ ++d,s=Unicorn.AddBacklay(o,e,-100,a,{scale:{x:2,y:2}});s.name=o,s.progress=0,s.offset=t,_.push(s)}function v(e){let a=b(10),t="snow_"+ ++d,n=Unicorn.AddBacklay(t,e,b(1920),-100,{scale:{x:2,y:2}});n.name=t,n.progress=0,n.offset=a,k.push(n)}function U(e){let a=b(2160)-1080,t=b(10),n="leaf_"+ ++d,o=Unicorn.AddBacklay(n,e,-100,a,{scale:{x:3,y:3}});o.name=n,o.progress=0,o.offset=t,w.push(o)}function L(e){const a=b(1920);for(let t=0;t<1;t++){let t="floaty_"+ ++d;const n=b(10),o=b(100),s=Math.random()*Math.PI;let r=Unicorn.AddBacklay(t,e,a-5+n,1080+o,{scale:{x:3,y:3}});r.timeOffset=s,r.label=t,r.zIndex=11,r.refX=a,r.refY=1080,r.lifetime=10,r.anchor.set(.5),$.push(r)}}function I(e,a){const t=a/1e3;for(let e=0;e<_.length;e++){let a=_[e].progress+=t/10;a>=1?(Unicorn.RemoveBacklay(_[e].name),_.splice(e--,1)):n.leaves2?(_[e].x=2480*Math.sin(a)-100,_[e].y+=Math.sin(20*a+_[e].offset),_[e].angle=10*Math.cos(20*a)+60*_[e].offset):(_[e].x=2480*Math.sin(a)-100,_[e].y+=t/10*1080+_[e].offset/10+Math.sin(20*a+_[e].offset),_[e].angle=10*Math.cos(20*a)+60*_[e].offset)}for(let e=0;e<k.length;e++){let a=k[e].progress+=t/10;a>=1?(Unicorn.RemoveBacklay(k[e].name),k.splice(e--,1)):(k[e].y+=t/10*1180+k[e].offset/10+Math.sin(20*a+k[e].offset),k[e].angle=10*Math.cos(20*a)+60*k[e].offset)}for(let e=0;e<w.length;e++){let a=w[e].progress+=t/10;a>=1?(Unicorn.RemoveBacklay(w[e].name),w.splice(e--,1)):(w[e].x=2480*Math.sin(a)-100,w[e].y+=t/10*1080+w[e].offset/10+Math.sin(20*a+w[e].offset),w[e].angle=10*Math.cos(20*a)+60*w[e].offset)}for(let e=0;e<$.length;e++){let t=$[e];t.lifetime>0&&(t.lifetime-=a/1e3,t.y-=180*a/1e3,t.x=t.refX+20*Math.sin(4*t.lifetime+t.timeOffset),t.lifetime<0&&(Unicorn.RemoveBacklay(t.label),$.splice(e,1),e--))}}function x(e,a,t,o,s){if(o.mod||o.broadcaster||o.vip){if("raindrop"===a){const e=parseInt(t||"10"),a=4;for(let t=0;t<a;t++)for(let t=0;t<e/a;t++)setTimeout((()=>{h()}),150*(t+a)+b(2e3))}if("leaf"===a){const e=parseInt(t||"10"),a=4;for(let t=0;t<a;t++)for(let t=0;t<e/a;t++)setTimeout((()=>{y(u[b(u.length)])}),(n.leaves2?100:150)*(t+a)+b(n.leaves2?100:2e3))}if("snow"===a){const e=parseInt(t||"10"),a=4;for(let t=0;t<a;t++)for(let t=0;t<e/a;t++)setTimeout((()=>{v(m[b(m.length)])}),(n.leaves2?100:150)*(t+a)+b(n.leaves2?100:2e3))}if("blossom"===a){const e=parseInt(t||"10"),a=4;for(let t=0;t<a;t++)for(let t=0;t<e/a;t++)setTimeout((()=>{U(p[b(p.length)])}),150*(t+a)+b(2e3))}if("heart"===commands){const e=parseInt(t||"10"),a=4;for(let t=0;t<a;t++)for(let t=0;t<e/a;t++)setTimeout((()=>{const e=b(g.length);L(g[e])}),150*(t+a)+b(2e3))}}}let M=0;function S(e,a,t,o,l){if(M=(M+1)%s,0===M){if(n.leaves||n.leaves2)for(let e=0;e<r;e++)y(u[b(u.length)]);if(n.snow)for(let e=0;e<r;e++)v(m[b(m.length)]);if(n.blossoms)for(let e=0;e<r;e++)U(p[b(p.length)]);if(n.rain)for(let e=0;e<r;e++)h();if(n.hearts)for(let e=0;e<r;e++){const e=b(g.length);L(g[e])}}}function b(e){return Math.floor(e*Math.random())}async function A(e){return await fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${e}`}}).then((e=>e.json())).catch((e=>({error:e})))}async function T(e){return await fetch(`https://api.pixelplush.dev/v1/auth/refresh?token=${e}`).then((e=>e.json())).catch((e=>({error:e})))}var C="";async function O(){return fetch(`${e}/analytics/heartbeat`,{method:"POST",body:JSON.stringify({session:C,game:"flakes",theme:a,channel:n.channel,players:[n.channel],count:1})}).then((e=>e.json()))}window.setupGame=function(i,c,h){a=i,t=c,n=h,o=t.path||"",s=h.nth||1,r=parseInt(h.num||3),l=parseInt(h.timer||0),async function(){try{const a=(await fetch(`${o}/assets/shamelist.txt`).then((e=>e.text()))).split(",").map((e=>e.trim().toLowerCase()));if(n.channel&&a&&a.includes(n.channel.toLowerCase())&&(console.log("This channel has been blocked for violating the PixelPlush Terms of Service."),!1),n.oauth&&(n.oauth=await async function(e,a){const t=localStorage.getItem("pixelplush_token"),n=localStorage.getItem("pixelplush_refresh");if(t){const e=await A(t);if(e&&e.user_id)return t}if(n){const e=await T(n);if(e&&e.user_id)return localStorage.setItem("pixelplush_token",e.access_token),localStorage.setItem("pixelplush_refresh",e.refresh_token),e.access_token}if((await A(e)).user_id)return localStorage.setItem("pixelplush_token",e),localStorage.setItem("pixelplush_refresh",a),e;if(a){const e=await T(a);if(e&&e.user_id)return localStorage.setItem("pixelplush_token",e.access_token),localStorage.setItem("pixelplush_refresh",e.refresh_token),e.access_token}return null}(n.oauth.replace("oauth:",""),n.refreshToken)),t.requires)try{if(account=await fetch(`${e}/accounts`,{headers:{Twitch:n.oauth?n.oauth.replace("oauth:",""):void 0}}).then((e=>e.json())),console.log(account),account.error)throw"Login Error";if(!account.owned.includes(t.requires))throw"Item not owned"}catch(e){return void console.log("Auth Validate Failed",e)}}catch(e){console.log(e)}Unicorn.Create("unicorn-display",{width:1920,height:1080,background:"transparent",init:f,update:I,channel:n.channel,username:n.oauth?n.channel:void 0,password:n.oauth?n.oauth.replace("oauth:",""):void 0,onCommand:x,onChat:S,gravity:{x:0,y:0}}),ComfyJS.onConnected=async(e,a,t)=>{if(t){let e=await O();0!==e&&(C=e.session,setInterval((()=>{O()}),6e4))}}}()};